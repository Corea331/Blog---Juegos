{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

<title>{% block title %}{{ object.titulo }}{% endblock %}</title>
{% block extra_css %}
    <link rel="stylesheet" href="estilos_blog.css">
{% endblock %}

{% block contenido %}
<div class="container mt-4">
    <div class="card shadow-sm p-4">
        <!-- Título del artículo -->
        <h1>{{ object.titulo }}</h1>
        {% if object.subtitulo %}
            <p><em>{{ object.subtitulo }}</em></p>
        {% endif %}

        <!-- Metadatos del artículo -->
        <p class="card-text">
            <small class="text-muted">
                Publicado el {{ object.fecha_publicacion|date:"d M Y" }}
                {% if object.autor %}
                    por {{ object.autor.username }}
                {% endif %}
                {% if object.categoria %}
                    en {{ object.categoria.nombre }}
                {% endif %}
            </small>
        </p>

        <hr>

        <div class="contenido_articulo">
            <!-- Lógica para mostrar la imagen (prioriza la URL sobre el archivo) -->
            {% if object.imagen_url %}
                <img src="{{ object.imagen_url }}" alt="{{ object.titulo }}" class="articulo-imagen img-fluid rounded mb-3">
            {% elif object.imagen_principal %}
                <img src="{{ object.imagen_principal.url }}" alt="{{ object.titulo }}" class="articulo-imagen img-fluid rounded mb-3">
            {% else %}
                <img src="https://placehold.co/900x400/2980b9/ffffff?text=No+Imagen" alt="Sin imagen disponible" class="articulo-imagen img-fluid rounded mb-3">
            {% endif %}

            <!-- El contenido del artículo, ahora con el filtro 'linebreaks' para mantener los saltos de línea -->
            {{ object.contenido|linebreaks }}
        </div>
    
        <!-- Sección comentario -->
        <div class="mt-5">
            <h3>Comentarios</h3>
            <hr>
            <center>
            {% if user.is_authentiated %}
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Deja tu comentario</h5>
                    <form action="{% url 'apps.blog:detalle_articulo' pk=object.pk %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="articulo_id" value="{{ object.id }}">
                        <div class="mb-3">
                            <textarea name="texto" class="form-control" rows="4"  required
                            placeholder="Escribe tu comentario aqui..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Publicar comentario</button>
                    </form>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                Debes <a href="{% url 'apps.users:login' %}?next={{ request.path }}">Iniciar Sesión</a> para dejar tu comentario
            </div>
            </center>
            {% endif %}
        
            <!-- Lista de comentarios -->
            <div class="lista_comentarios">
                {% for comentario in object.comentarios.all %}
                    {% if comentario.aprobado or comentario.user == user %}
                    <div class="card mb-3 {% if not comentario.aprobado %}bg-ligth{% endif %}">
                        <div class="card-body">
                            <div class="d-flex juestify-content-between">
                                <h6 class="card-subtitle mb-2 text-muted">
                                    {{ comentario.usuario.username }}
                                    <small>{{ comentario.fecha_creacion|date:'d M Y H:i' }}</small>
                                </h6>
                                {% if not comentario.aprobado %}
                                    <span class="badge bg-warning text-dark">Pendiente de aprobación</span>
                                {% endif %}
                            </div>
                            <div class="card-text">{{ comentario.texto|linebreaks }}</div>
                        </div>
                    </div>
                    {% endif %}
                {% empty %}
                <div class="alert alert-secondary">
                    No hay comentarios aún. Se el primero en comentar.
                </div>
                {% endfor %}
            </div>
        </div>
        <a href="{% url 'apps.blog:lista_articulos' %}" class="btn btn-secondary">&larr; Volver a los articulos</a>
    </div>
</div>

{% endblock contenido %}